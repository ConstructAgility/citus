-- This file includes tests for schema support
CREATE SCHEMA tpch;
NOTICE:  Citus partially supports CREATE SCHEMA for distributed databases
DETAIL:  schema usage in joins and in some UDFs provided by Citus are not supported yet
-- Set the search path to tpch
SET search_path TO tpch;
-- Below tests cover the followings on different schemas:
-- Create table, create shards for both hash and append partition tables
-- drop shards via master_apply_delete_command()
CREATE TABLE nation_append (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
SELECT master_create_distributed_table('nation_append', 'n_nationkey', 'append');
 master_create_distributed_table 
---------------------------------
 
(1 row)

\COPY nation_append FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/nation.data' with delimiter '|'
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102008" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_append_102008" does not exist
ERROR:  could not find any active placements
SELECT master_create_empty_shard('nation_append');
 master_create_empty_shard 
---------------------------
                    102009
(1 row)

SELECT count(*) FROM nation_append;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
ERROR:  failed to execute job 2
DETAIL:  Failure due to failed task 2
-- Set the search path to public
SET search_path TO public;
\COPY tpch.nation_append FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/nation.data' with delimiter '|'
SELECT master_create_empty_shard('nation_append');
ERROR:  relation "nation_append" does not exist
SELECT count(*) FROM tpch.nation_append;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
ERROR:  failed to execute job 3
DETAIL:  Failure due to failed task 4
-- Set the search path to public
SET search_path TO public;
CREATE TABLE tpch.nation_hash (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
SELECT master_create_distributed_table('tpch.nation_hash', 'n_nationkey', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('tpch.nation_hash', 4, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

-- now drop the shards
SELECT master_apply_delete_command('DELETE FROM tpch.nation_hash');
 master_apply_delete_command 
-----------------------------
                           4
(1 row)

CREATE TABLE tpch.nation_hash_2 (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
SELECT master_create_distributed_table('tpch.nation_hash_2', 'n_nationkey', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('tpch.nation_hash_2', 4, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

CREATE TABLE tpch.nation_append_2 (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
SELECT master_create_distributed_table('tpch.nation_append_2', 'n_nationkey', 'append');
 master_create_distributed_table 
---------------------------------
 
(1 row)

\COPY tpch.nation_append_2 FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/nation.data' with delimiter '|'
-- Set the search path to tpch and create -  drop shards
SET search_path TO tpch;
SELECT master_create_distributed_table('nation_hash', 'n_nationkey', 'hash');
ERROR:  table "nation_hash" is already distributed
SELECT master_create_worker_shards('nation_hash', 4, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

-- now drop the shards
SELECT master_apply_delete_command('DELETE FROM nation_hash');
 master_apply_delete_command 
-----------------------------
                           4
(1 row)

-- now create the shards for the rest of the test
SELECT master_create_worker_shards('tpch.nation_hash', 4, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

-- create one more schema
CREATE SCHEMA tpch_2;
NOTICE:  Citus partially supports CREATE SCHEMA for distributed databases
DETAIL:  schema usage in joins and in some UDFs provided by Citus are not supported yet
SET search_path to public;
-- Create the tables for the rest of the tests
CREATE TABLE tpch_2.nation_append (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
SELECT master_create_distributed_table('tpch_2.nation_append', 'n_nationkey', 'append');
 master_create_distributed_table 
---------------------------------
 
(1 row)

\COPY tpch_2.nation_append FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/nation.data' with delimiter '|'
SELECT master_create_empty_shard('tpch_2.nation_append');
 master_create_empty_shard 
---------------------------
                    102029
(1 row)

SELECT count(*) from tpch_2.nation_append;
 count 
-------
    25
(1 row)

CREATE TABLE tpch_2.nation_hash (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
SELECT master_create_distributed_table('tpch_2.nation_hash', 'n_nationkey', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('tpch_2.nation_hash', 4, 2);
 master_create_worker_shards 
-----------------------------
 
(1 row)

SET search_path TO public;
CREATE TABLE nation_local
(
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152));
\COPY public.nation_local FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/nation.data' with delimiter '|'
SET search_path TO public;
CREATE TYPE tpch.new_composite_type as (key1 text, key2 text);
-- we need to create the composite types from the test rather than pg_regress.pl
-- since it depends on the schema
\c - - - :worker_1_port
CREATE TYPE tpch.new_composite_type as (key1 text, key2 text);
\c - - - :worker_2_port
CREATE TYPE tpch.new_composite_type as (key1 text, key2 text);
-- connect back to the master
\c - - - :master_port
CREATE TABLE tpch.nation_hash_with_composites (
    n_nationkey integer not null,
    n_name char(25) not null,
    n_regionkey integer not null,
    n_comment varchar(152),
    test_col tpch.new_composite_type
    );
SELECT master_create_distributed_table('tpch.nation_hash_with_composites', 'n_nationkey', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('tpch.nation_hash_with_composites', 4, 2);
 master_create_worker_shards 
-----------------------------
 
(1 row)

\COPY nation_hash_with_composites FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/nation.data' with delimiter '|'
ERROR:  relation "nation_hash_with_composites" does not exist
-- create lineitem table as well
CREATE TABLE tpch.lineitem (
    l_orderkey bigint not null,
    l_partkey integer not null,
    l_suppkey integer not null,
    l_linenumber integer not null,
    l_quantity decimal(15, 2) not null,
    l_extendedprice decimal(15, 2) not null,
    l_discount decimal(15, 2) not null,
    l_tax decimal(15, 2) not null,
    l_returnflag char(1) not null,
    l_linestatus char(1) not null,
    l_shipdate date not null,
    l_commitdate date not null,
    l_receiptdate date not null,
    l_shipinstruct char(25) not null,
    l_shipmode char(10) not null,
    l_comment varchar(44) not null,
     PRIMARY KEY(l_orderkey, l_linenumber) );
SELECT master_create_distributed_table('tpch.lineitem', 'l_orderkey', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('tpch.lineitem', 16, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

COPY tpch.lineitem FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/lineitem.1.data' with delimiter '|';
COPY tpch.lineitem FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/lineitem.2.data' with delimiter '|';
CREATE TABLE tpch.orders (
    o_orderkey bigint not null,
    o_custkey integer not null,
    o_orderstatus char(1) not null,
    o_totalprice decimal(15,2) not null,
    o_orderdate date not null,
    o_orderpriority char(15) not null,
    o_clerk char(15) not null,
    o_shippriority integer not null,
    o_comment varchar(79) not null,
    PRIMARY KEY(o_orderkey) );
SELECT master_create_distributed_table('tpch.orders', 'o_orderkey', 'hash');
 master_create_distributed_table 
---------------------------------
 
(1 row)

SELECT master_create_worker_shards('tpch.orders', 16, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

COPY tpch.orders FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/orders.1.data' with delimiter '|';
COPY tpch.orders FROM '/Users/onderkalaci/Documents/citus_code/citus/src/test/regress/data/orders.2.data' with delimiter '|';
-- Test EXPLAIN on different search paths
-- TODO: add COSTS FALSE to explain as multi_explain.sql
SET search_path to tpch;
EXPLAIN SELECT * FROM nation_append;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Distributed Query into pg_merge_job_0005
   Executor: Real-Time
   Task Count: 2
   Tasks Shown: One of 2
   ->  Task
         Error: Could not get remote plan.
 Master Query
   ->  Seq Scan on pg_merge_job_0005  (cost=0.00..0.00 rows=0 width=0)
(8 rows)

SET search_path to public;
EXPLAIN SELECT * FROM tpch.nation_append;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_append_102009" does not exist
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Distributed Query into pg_merge_job_0006
   Executor: Real-Time
   Task Count: 2
   Tasks Shown: One of 2
   ->  Task
         Error: Could not get remote plan.
 Master Query
   ->  Seq Scan on pg_merge_job_0006  (cost=0.00..0.00 rows=0 width=0)
(8 rows)

-- Test worker_fetch_regular_table
SELECT count(*) FROM tpch.nation_append t1, tpch.nation_append_2 t2 WHERE t1.n_name = t2.n_name;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
ERROR:  failed to execute job 7
DETAIL:  Failure due to failed task 6
SET search_path TO tpch;
SELECT count(*) FROM nation_append t1, nation_append_2 t2 WHERE t1.n_name = t2.n_name;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_append_2_102019"
ERROR:  failed to execute job 8
DETAIL:  Failure due to failed task 3
-- now test master_append_table_to_shard, start with public schema
SET search_path TO public;
SELECT master_create_empty_shard('tpch.nation_append') AS new_shard_id
\gset
SELECT master_append_table_to_shard(:new_shard_id, 'nation_local', 'localhost', 5432);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not copy table "nation_local" from "localhost:5432"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not copy table "nation_local" from "localhost:5432"
ERROR:  could not append table to any shard placement
-- now try on tpch schema
set search_path TO tpch;
SELECT master_append_table_to_shard(:new_shard_id, 'nation_local', 'localhost', 5432);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not copy table "nation_local" from "localhost:5432"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not copy table "nation_local" from "localhost:5432"
ERROR:  could not append table to any shard placement
-- now explicitly check master_create_empty_shard on both schemas
SET search_path TO public;
SELECT master_create_empty_shard('tpch.nation_append');
 master_create_empty_shard 
---------------------------
                    102071
(1 row)

SET search_path TO tpch;
SELECT master_create_empty_shard('nation_append');
 master_create_empty_shard 
---------------------------
                    102072
(1 row)

-- Try modify/router queries
SET search_path TO public;
INSERT INTO tpch.nation_hash (n_nationkey) VALUES (26);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: null value in column "n_name" violates not-null constraint
ERROR:  could not modify any active placements
SELECT * FROM tpch.nation_hash WHERE n_nationkey = 25;
 n_nationkey | n_name | n_regionkey | n_comment 
-------------+--------+-------------+-----------
(0 rows)

SET search_path TO tpch;
INSERT INTO nation_hash (n_nationkey) VALUES (26);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: null value in column "n_name" violates not-null constraint
ERROR:  could not modify any active placements
SELECT * FROM nation_hash WHERE n_nationkey = 25;
 n_nationkey | n_name | n_regionkey | n_comment 
-------------+--------+-------------+-----------
(0 rows)

-- now test create / drop indexes
SET search_path TO public;
CREATE INDEX i1 ON tpch.nation_hash(n_name);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
ERROR:  could not execute DDL command on worker node shards
DROP INDEX tpch.i1;
ERROR:  index "i1" does not exist
SET search_path TO tpch;
CREATE INDEX i2 ON nation_hash(n_nationkey);
DROP INDEX i2;
-- now test COPY dist_table TO
SET search_path TO public;
COPY tpch.nation_hash TO STDOUT;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 9
DETAIL:  Failure due to failed task 2
SET search_path TO tpch;
COPY nation_hash TO STDOUT;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 10
DETAIL:  Failure due to failed task 2
-- now test CREATE TABLE AS
SET search_path TO public;
CREATE TABLE nation_copy_1 AS (SELECT * FROM tpch.nation_hash);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 11
DETAIL:  Failure due to failed task 2
SET search_path TO tpch;
CREATE TABLE nation_copy_1 AS (SELECT * FROM nation_hash);
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 12
DETAIL:  Failure due to failed task 2
-- now test JOINS on/cross schemas
-- the tests includes co-located joins, range-repartition joins
-- and hash-repartition joins
-- start with co-located JOINs
SET search_path TO public;
SELECT
    count (*)
FROM
    tpch.nation_hash n1, tpch_2.nation_hash n2
WHERE
    n1.n_nationkey = n2.n_nationkey;
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
ERROR:  failed to execute job 13
DETAIL:  Failure due to failed task 3
SET search_path TO tpch;
SELECT
    count (*)
FROM
    nation_hash n1, tpch_2.nation_hash n2
WHERE
    n1.n_nationkey = n2.n_nationkey;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
ERROR:  failed to execute job 14
DETAIL:  Failure due to failed task 3
SET search_path TO tpch_2;
SELECT
    count (*)
FROM
    tpch.nation_hash n1, nation_hash n2
WHERE
    n1.n_nationkey = n2.n_nationkey;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102030"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102031"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_102032"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_102033"
ERROR:  failed to execute job 15
DETAIL:  Failure due to failed task 3
-- now test the tables that are on the same schema
SET search_path TO public;
SELECT
    count (*)
FROM
    tpch.nation_hash n1, tpch.nation_hash_2 n2
WHERE
    n1.n_nationkey = n2.n_nationkey;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102015"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102016"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102017"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102018"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102015"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102016"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102017"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102018"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102015"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102016"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102017"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102018"
ERROR:  failed to execute job 16
DETAIL:  Failure due to failed task 3
SET search_path TO tpch;
SELECT
    count (*)
FROM
    nation_hash n1, nation_hash_2 n2
WHERE
    n1.n_nationkey = n2.n_nationkey;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102015"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102016"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102017"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102018"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102015"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102016"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102017"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102018"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102015"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102016"
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102017"
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: could not fetch relation: "nation_hash_2_102018"
ERROR:  failed to execute job 17
DETAIL:  Failure due to failed task 3
-- now test single-repartition JOINs
SET search_path TO public;
SELECT
    count (*)
FROM
    tpch.nation_hash n1, tpch_2.nation_hash n2
WHERE
    n1.n_nationkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
SET search_path TO tpch;
SELECT
    count (*)
FROM
    nation_hash n1, nation_hash_2 n2
WHERE
    n1.n_nationkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
SET search_path TO tpch;
SELECT
    count (*)
FROM
    nation_hash n1, tpch_2.nation_hash n2
WHERE
    n1.n_nationkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
SET search_path TO tpch_2;
SELECT
    count (*)
FROM
    nation_hash n1, tpch.nation_hash n2
WHERE
    n1.n_nationkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
-- hash-repatitionin tests
SET search_path TO public;
SELECT
    count (*)
FROM
    tpch.nation_hash n1, tpch_2.nation_hash n2
WHERE
    n1.n_regionkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
SET search_path TO tpch;
SELECT
    count (*)
FROM
    nation_hash n1, nation_hash_2 n2
WHERE
    n1.n_regionkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
SET search_path TO tpch;
SELECT
    count (*)
FROM
    nation_hash n1, tpch_2.nation_hash n2
WHERE
    n1.n_regionkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
SET search_path TO tpch_2;
SELECT
    count (*)
FROM
    tpch.nation_hash n1, nation_hash n2
WHERE
    n1.n_regionkey = n2.n_regionkey;
ERROR:  cannot use real time executor with repartition jobs
HINT:  Set citus.task_executor_type to "task-tracker".
-- test master_copy_shard_placement()
SELECT shardid as newshardid FROM pg_dist_shard WHERE logicalrelid = 'tpch_2.nation_hash'::regclass LIMIT 1
\gset
-- now, update the second placement as unhealthy
UPDATE pg_dist_shard_placement SET shardstate = 3 WHERE shardid = :newshardid AND nodeport = :worker_2_port;
SET search_path TO tpch;
SELECT master_copy_shard_placement(:newshardid, 'localhost', :worker_1_port, 'localhost', :worker_2_port);
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "nation_hash_102033" already exists
WARNING:  could not create shard on "localhost:57638"
ERROR:  could only create 0 of 1 of required shard replicas
-- again, update the second placement as unhealthy
UPDATE pg_dist_shard_placement SET shardstate = 3 WHERE shardid = :newshardid AND nodeport = :worker_2_port;
SET search_path TO public;
SELECT master_copy_shard_placement(:newshardid, 'localhost', :worker_1_port, 'localhost', :worker_2_port);
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "nation_hash_102033" already exists
WARNING:  could not create shard on "localhost:57638"
ERROR:  could only create 0 of 1 of required shard replicas
-- test aggregation queries
SET search_path TO tpch ;
SELECT max(n_regionkey) FROM nation_hash ;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 42
DETAIL:  Failure due to failed task 2
set search_path to public;
SELECT max(n_regionkey) FROM tpch.nation_hash ;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 43
DETAIL:  Failure due to failed task 2
SET search_path TO tpch;
SELECT array_agg(n_name) FROM nation_hash GROUP BY n_regionkey
        ORDER BY n_regionkey LIMIT 10;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 44
DETAIL:  Failure due to failed task 2
SET search_path TO public;
SELECT array_agg(n_name) FROM tpch.nation_hash GROUP BY n_regionkey
        ORDER BY n_regionkey LIMIT 10;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 45
DETAIL:  Failure due to failed task 2
-- approximate aggreagtes
SET citus.count_distinct_error_rate TO 0.01;
SELECT COUNT (DISTINCT n_regionkey) FROM tpch.nation_hash;
ERROR:  cannot compute count (distinct) approximation
HINT:  You need to have the hll extension loaded.
SET search_path TO tpch ;
SELECT COUNT (DISTINCT n_regionkey) FROM nation_hash;
ERROR:  cannot compute count (distinct) approximation
HINT:  You need to have the hll extension loaded.
-- test UDF creation on different schemas
-- do this on both the master and workers
SET search_path TO public;
CREATE OR REPLACE FUNCTION dummyFunction(theValue integer)
    RETURNS text AS
$$
DECLARE
    strresult text;
BEGIN
    RETURN theValue * 3 / 2 + 1;
END;
$$
LANGUAGE 'plpgsql' IMMUTABLE;
SET search_path TO tpch;
CREATE OR REPLACE FUNCTION dummyFunction2(theValue integer)
    RETURNS text AS
$$
DECLARE
    strresult text;
BEGIN
    RETURN theValue * 3 / 2 + 1;
END;
$$
LANGUAGE 'plpgsql' IMMUTABLE;
\c - - - :worker_1_port
SET search_path TO public;
CREATE OR REPLACE FUNCTION dummyFunction(theValue integer)
    RETURNS text AS
$$
DECLARE
    strresult text;
BEGIN
    RETURN theValue * 3 / 2 + 1;
END;
$$
LANGUAGE 'plpgsql' IMMUTABLE;
SET search_path TO tpch;
CREATE OR REPLACE FUNCTION dummyFunction2(theValue integer)
    RETURNS text AS
$$
DECLARE
    strresult text;
BEGIN
    RETURN theValue * 3 / 2 + 1;
END;
$$
LANGUAGE 'plpgsql' IMMUTABLE;
\c - - - :worker_2_port
SET search_path TO public;
CREATE OR REPLACE FUNCTION dummyFunction(theValue integer)
    RETURNS text AS
$$
DECLARE
    strresult text;
BEGIN
    RETURN theValue * 3 / 2 + 1;
END;
$$
LANGUAGE 'plpgsql' IMMUTABLE;
SET search_path TO tpch;
CREATE OR REPLACE FUNCTION dummyFunction2(theValue integer)
    RETURNS text AS
$$
DECLARE
    strresult text;
BEGIN
    RETURN theValue * 3 / 2 + 1;
END;
$$
LANGUAGE 'plpgsql' IMMUTABLE;
-- connect back to the master
\c - - - :master_port
SET search_path TO public;
SELECT dummyFunction(n_nationkey) FROM tpch.nation_hash  GROUP BY 1;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 46
DETAIL:  Failure due to failed task 2
-- works fine
SET search_path TO public;
SELECT dummyFunction(n_nationkey) FROM nation_hash  GROUP BY 1;
ERROR:  relation "nation_hash" does not exist
LINE 1: SELECT dummyFunction(n_nationkey) FROM nation_hash  GROUP BY...
                                               ^
SET search_path TO public;
SELECT tpch.dummyFunction2(n_nationkey) FROM tpch.nation_hash  GROUP BY 1;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 47
DETAIL:  Failure due to failed task 2
SET search_path TO tpch;
SELECT dummyFunction2(n_nationkey) FROM nation_hash  GROUP BY 1;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 48
DETAIL:  Failure due to failed task 2
-- test composite type creation on different schemas
SET search_path TO public;
SELECT * FROM tpch.nation_hash_with_composites  WHERE test_col = '(a,a)'::tpch.new_composite_type;
 n_nationkey | n_name | n_regionkey | n_comment | test_col 
-------------+--------+-------------+-----------+----------
(0 rows)

SET search_path TO tpch;
SELECT * FROM nation_hash_with_composites WHERE test_col = '(a,a)'::new_composite_type;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: type "new_composite_type" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: type "new_composite_type" does not exist
ERROR:  failed to execute job 50
DETAIL:  Failure due to failed task 2
-- test prepared statements
SET search_path TO public;
PREPARE preparedStatementCreatedOnPublic AS SELECT * FROM tpch.nation_hash;
SET search_path TO tpch;
PREPARE preparedStatementCreatedOnTPCH1 AS SELECT * FROM nation_hash;
SET search_path TO public;
EXECUTE preparedStatementCreatedOnPublic;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 51
DETAIL:  Failure due to failed task 2
EXECUTE preparedStatementCreatedOnTPCH1;
ERROR:  relation "nation_hash" does not exist
SET search_path TO tpch;
EXECUTE preparedStatementCreatedOnPublic;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 52
DETAIL:  Failure due to failed task 2
EXECUTE preparedStatementCreatedOnTPCH1;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 53
DETAIL:  Failure due to failed task 2
-- try on real-time executor
SET search_path TO public;
BEGIN;
DECLARE test_cursor CURSOR FOR
    SELECT *
        FROM tpch.nation_hash;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 54
DETAIL:  Failure due to failed task 2
        FETCH test_cursor;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
FETCH test_cursor;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
END;
SET search_path TO tpch;
BEGIN;
DECLARE test_cursor CURSOR FOR
    SELECT *
        FROM nation_hash;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102025" does not exist
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102026" does not exist
WARNING:  Bad result from localhost:57638
DETAIL:  Remote message: relation "tpch.nation_hash_102027" does not exist
ERROR:  failed to execute job 55
DETAIL:  Failure due to failed task 2
        FETCH test_cursor;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
FETCH test_cursor;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
END;
-- try on router executor
SET search_path TO public;
BEGIN;
DECLARE test_cursor CURSOR FOR
    SELECT *
        FROM tpch.nation_hash
        WHERE n_nationkey = 1;
        FETCH test_cursor;
 n_nationkey | n_name | n_regionkey | n_comment 
-------------+--------+-------------+-----------
(0 rows)

FETCH test_cursor;
ERROR:  scan directions other than forward scans are unsupported
END;
SET search_path TO tpch;
BEGIN;
DECLARE test_cursor CURSOR FOR
    SELECT *
        FROM nation_hash
        WHERE n_nationkey = 1;
        FETCH test_cursor;
 n_nationkey | n_name | n_regionkey | n_comment 
-------------+--------+-------------+-----------
(0 rows)

FETCH test_cursor;
ERROR:  scan directions other than forward scans are unsupported
END;
-- Tests including single table repartition and subquery pushdown
SET search_path TO public;
SET citus.task_executor_type TO 'task-tracker';
select
    total,
    avg(avg_count) as total_avg_count
from
    (select
        number_sum,
        count(*) as total,
        avg(total_count) avg_count
    from
        (select
            l_suppkey,
            sum(l_linenumber) as number_sum,
            count(*) as total_count
        from
            tpch.lineitem
        where
            l_partkey > 100 and
            l_quantity > 2 and
            l_orderkey < 10000
        group by
            l_suppkey) as distributed_table
    where
        number_sum >= 10
    group by
        number_sum) as distributed_table_2
group by
    total
order by
    total;
 total |  total_avg_count   
-------+--------------------
     1 | 4.8000000000000000
     6 | 3.0000000000000000
    10 | 3.5000000000000000
    27 | 2.9259259259259259
    32 | 2.8125000000000000
    57 | 2.4912280701754386
    77 | 2.3896103896103896
(7 rows)

SET search_path TO tpch;
select
    total,
    avg(avg_count) as total_avg_count
from
    (select
        number_sum,
        count(*) as total,
        avg(total_count) avg_count
    from
        (select
            l_suppkey,
            sum(l_linenumber) as number_sum,
            count(*) as total_count
        from
            lineitem
        where
            l_partkey > 100 and
            l_quantity > 2 and
            l_orderkey < 10000
        group by
            l_suppkey) as distributed_table
    where
        number_sum >= 10
    group by
        number_sum) as distributed_table_2
group by
    total
order by
    total;
 total |  total_avg_count   
-------+--------------------
     1 | 4.8000000000000000
     6 | 3.0000000000000000
    10 | 3.5000000000000000
    27 | 2.9259259259259259
    32 | 2.8125000000000000
    57 | 2.4912280701754386
    77 | 2.3896103896103896
(7 rows)

-- now test with subquery pushdown
SET citus.subquery TO on;
SET search_path TO public;
SELECT
    avg(unit_price)
FROM
    (SELECT
        l_orderkey,
        avg(o_totalprice / l_quantity) AS unit_price
    FROM
        tpch.lineitem,
        tpch.orders
    WHERE
        l_orderkey = o_orderkey
    GROUP BY
        l_orderkey) AS unit_prices
WHERE
    unit_price > 1000 AND
    unit_price < 10000;
ERROR:  cannot perform distributed planning on this query
DETAIL:  Join in subqueries is not supported yet
SET search_path TO tpch;
SELECT
    avg(unit_price)
FROM
    (SELECT
        l_orderkey,
        avg(o_totalprice / l_quantity) AS unit_price
    FROM
        lineitem,
        orders
    WHERE
        l_orderkey = o_orderkey
    GROUP BY
        l_orderkey) AS unit_prices
WHERE
    unit_price > 1000 AND
    unit_price < 10000;
ERROR:  cannot perform distributed planning on this query
DETAIL:  Join in subqueries is not supported yet
-- test ALTER TABLE commands
SET search_path TO public;
-- add column
ALTER TABLE tpch.nation_hash ADD COLUMN tmp_col INT;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
ERROR:  could not execute DDL command on worker node shards
-- drop column
ALTER TABLE tpch.nation_hash  DROP COLUMN IF EXISTS non_existent_column;
WARNING:  Bad result from localhost:57637
DETAIL:  Remote message: relation "tpch.nation_hash_102024" does not exist
ERROR:  could not execute DDL command on worker node shards
-- ALTER TABLE on tpch schema
SET search_path TO tpch;
ALTER TABLE nation_hash ADD COLUMN tmp_col_2 INT;
ALTER TABLE nation_hash  DROP COLUMN IF EXISTS non_existent_column;
NOTICE:  column "non_existent_column" of relation "nation_hash" does not exist, skipping
ALTER TABLE nation_hash ALTER COLUMN n_comment SET DEFAULT 'comment';
-- test master_modify_multiple_shards()
SET search_path TO public;
SELECT master_modify_multiple_shards('UPDATE tpch.nation_hash SET n_regionkey = n_regionkey + 1');
 master_modify_multiple_shards 
-------------------------------
                             0
(1 row)

SET search_path TO tpch;
SELECT master_modify_multiple_shards('UPDATE nation_hash SET n_regionkey = n_regionkey + 1');
 master_modify_multiple_shards 
-------------------------------
                             0
(1 row)

-- now set schema of table
SET search_path TO public;
ALTER TABLE nation_local SET SCHEMA tpch;
SELECT count(*) FROM tpch.nation_local;
 count 
-------
    25
(1 row)

ALTER TABLE tpch.nation_local SET SCHEMA public;
SELECT count(*) FROM nation_local;
 count 
-------
    25
(1 row)

SET search_path TO public;
ALTER TABLE nation_local SET SCHEMA tpch;
SELECT count(*) FROM tpch.nation_local;
 count 
-------
    25
(1 row)

SET search_path TO tpch;
ALTER TABLE nation_local SET SCHEMA tpch;
ERROR:  table nation_local is already in schema "tpch"
SELECT count(*) FROM nation_local;
 count 
-------
    25
(1 row)

-- test master_drop_all_shards()
SET search_path TO public;
SELECT master_drop_all_shards('tpch.nation_hash'::regclass, 'tpch', 'nation_hash');
 master_drop_all_shards 
------------------------
                      4
(1 row)

-- add new shard
SELECT master_create_worker_shards('tpch.nation_hash', 4, 1);
 master_create_worker_shards 
-----------------------------
 
(1 row)

SET search_path TO tpch;
SELECT master_drop_all_shards('nation_hash'::regclass, 'tpch', 'nation_hash');
 master_drop_all_shards 
------------------------
                      4
(1 row)

-- test master_get_table_metadata()
SET search_path TO public;
SELECT * FROM master_get_table_metadata('tpch.nation_hash');
 logical_relid | part_storage_type | part_method |  part_key   | part_replica_count | part_max_size | part_placement_policy 
---------------+-------------------+-------------+-------------+--------------------+---------------+-----------------------
         16478 | t                 | h           | n_nationkey |                  2 |        307200 |                     2
(1 row)

SET search_path TO tpch;
SELECT * FROM master_get_table_metadata('nation_hash');
 logical_relid | part_storage_type | part_method |  part_key   | part_replica_count | part_max_size | part_placement_policy 
---------------+-------------------+-------------+-------------+--------------------+---------------+-----------------------
         16478 | t                 | h           | n_nationkey |                  2 |        307200 |                     2
(1 row)

-- test master_get_table_ddl_events()
SET search_path TO public;
SELECT * FROM master_get_table_ddl_events('tpch.nation_hash');
                                                                                             master_get_table_ddl_events                                                                                             
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE SCHEMA IF NOT EXISTS tpch
 CREATE TABLE tpch.nation_hash (n_nationkey integer NOT NULL, n_name character(25) NOT NULL, n_regionkey integer NOT NULL, n_comment character varying(152) DEFAULT 'comment'::character varying, tmp_col_2 integer)
(2 rows)

SET search_path TO tpch;
SELECT * FROM master_get_table_ddl_events('nation_hash');
                                                                                          master_get_table_ddl_events                                                                                           
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE SCHEMA IF NOT EXISTS tpch
 CREATE TABLE nation_hash (n_nationkey integer NOT NULL, n_name character(25) NOT NULL, n_regionkey integer NOT NULL, n_comment character varying(152) DEFAULT 'comment'::character varying, tmp_col_2 integer)
(2 rows)

-- test master_update_shard_statistics()
SET search_path TO public;
SELECT master_create_empty_shard('tpch.nation_append') AS new_shard_id
\gset
SET search_path TO public;
SELECT * FROM master_update_shard_statistics(:new_shard_id);
 master_update_shard_statistics 
--------------------------------
                              0
(1 row)

SET search_path TO tpch;
SELECT * FROM master_update_shard_statistics(:new_shard_id);
ERROR:  invalid input syntax for integer: ""
-- test DROP TABLE
SET search_path TO public;
DROP TABLE tpch.nation_hash;
SET search_path TO tpch;
DROP TABLE nation_hash;
ERROR:  table "nation_hash" does not exist
SET search_path TO public;
DROP SCHEMA tpch CASCADE;
NOTICE:  drop cascades to 9 other objects
DETAIL:  drop cascades to table tpch.nation_append
drop cascades to table tpch.nation_hash_2
drop cascades to table tpch.nation_append_2
drop cascades to type tpch.new_composite_type
drop cascades to table tpch.nation_hash_with_composites
drop cascades to table tpch.lineitem
drop cascades to table tpch.orders
drop cascades to function tpch.dummyfunction2(integer)
drop cascades to table tpch.nation_local
ERROR:  invalid input syntax for integer: ""
CONTEXT:  SQL statement "SELECT master_drop_all_shards(v_obj.objid, v_obj.schema_name, v_obj.object_name)"
PL/pgSQL function citus_drop_trigger() line 15 at PERFORM
DROP SCHEMA tpch_2 CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table tpch_2.nation_append
drop cascades to table tpch_2.nation_hash
